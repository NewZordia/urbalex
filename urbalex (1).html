<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UrbaLex â€” Assistant Juridique Urbanisme</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=IBM+Plex+Sans:wght@300;400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f2ed;
  --surface: #ffffff;
  --surface2: #faf8f5;
  --border: #e2ddd6;
  --border2: #d0c9bf;
  --navy: #1a2744;
  --navy2: #253458;
  --gold: #c8922a;
  --gold-light: #f0d898;
  --gold-pale: #fdf6e3;
  --text: #1a2744;
  --muted: #7a7060;
  --muted2: #a09585;
  --red: #c0392b;
  --green: #1a6b3c;
  --blue: #1a4a8a;
  --radius: 4px;
  --shadow: 0 2px 12px rgba(26,39,68,0.08);
  --shadow-lg: 0 8px 32px rgba(26,39,68,0.14);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'IBM Plex Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  font-size: 14px;
}

/* â”€â”€ Layout â”€â”€ */
.app { display: flex; height: 100vh; overflow: hidden; }

/* â”€â”€ Sidebar â”€â”€ */
.sidebar {
  width: 280px;
  flex-shrink: 0;
  background: var(--navy);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-logo {
  padding: 28px 24px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}

.logo-mark {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 6px;
}

.logo-icon {
  width: 36px;
  height: 36px;
  background: var(--gold);
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}

.logo-name {
  font-family: 'Playfair Display', serif;
  font-size: 22px;
  font-weight: 700;
  color: #fff;
  letter-spacing: -0.3px;
}

.logo-sub {
  font-size: 11px;
  color: rgba(255,255,255,0.4);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  padding-left: 46px;
}

.sidebar-section {
  padding: 16px 16px 8px;
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: rgba(255,255,255,0.3);
}

.sidebar-nav { flex: 1; overflow-y: auto; padding-bottom: 16px; }

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  cursor: pointer;
  border-radius: var(--radius);
  margin: 1px 8px;
  transition: background 0.2s, color 0.2s;
  color: rgba(255,255,255,0.6);
  font-size: 13px;
}

.nav-item:hover { background: rgba(255,255,255,0.07); color: #fff; }
.nav-item.active { background: var(--gold); color: var(--navy); font-weight: 600; }
.nav-item .nav-icon { font-size: 15px; width: 20px; text-align: center; }

.nav-badge {
  margin-left: auto;
  background: rgba(255,255,255,0.15);
  color: rgba(255,255,255,0.7);
  font-size: 10px;
  padding: 2px 7px;
  border-radius: 10px;
}

.nav-item.active .nav-badge { background: rgba(26,39,68,0.2); color: var(--navy); }

.sidebar-footer {
  padding: 16px;
  border-top: 1px solid rgba(255,255,255,0.08);
  font-size: 11px;
  color: rgba(255,255,255,0.3);
  display: flex;
  align-items: center;
  gap: 8px;
}

.status-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: #2ecc71;
  animation: blink 2s ease infinite;
  flex-shrink: 0;
}

@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* â”€â”€ Main â”€â”€ */
.main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

/* â”€â”€ Top bar â”€â”€ */
.topbar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 0 28px;
  height: 58px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}

.topbar-title {
  font-family: 'Playfair Display', serif;
  font-size: 17px;
  font-weight: 600;
  color: var(--navy);
}

.topbar-pills { display: flex; gap: 8px; }

.pill {
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 11px;
  border: 1px solid var(--border2);
  color: var(--muted);
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
}
.pill:hover { border-color: var(--gold); color: var(--gold); }
.pill.active { background: var(--navy); color: white; border-color: var(--navy); }

/* â”€â”€ Content areas (panels) â”€â”€ */
.panel { display: none; flex: 1; overflow: hidden; }
.panel.active { display: flex; flex-direction: column; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PANEL 1 â€” ASSISTANT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chat-wrapper {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* Chat zone */
.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 28px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.msg {
  display: flex;
  gap: 12px;
  animation: fadeMsg 0.3s ease;
  max-width: 820px;
}

@keyframes fadeMsg { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

.msg.user { flex-direction: row-reverse; align-self: flex-end; }

.msg-avatar {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 15px;
  flex-shrink: 0;
  margin-top: 2px;
}

.msg.assistant .msg-avatar { background: var(--navy); }
.msg.user .msg-avatar { background: var(--gold); }

.msg-bubble {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 2px 12px 12px 12px;
  padding: 14px 18px;
  line-height: 1.7;
  box-shadow: var(--shadow);
  max-width: 680px;
}

.msg.user .msg-bubble {
  background: var(--navy);
  color: #fff;
  border-color: var(--navy);
  border-radius: 12px 2px 12px 12px;
}

.msg-bubble p { margin-bottom: 10px; }
.msg-bubble p:last-child { margin-bottom: 0; }

/* Question cards */
.question-cards {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 12px;
}

.q-card {
  background: var(--gold-pale);
  border: 1px solid var(--gold-light);
  border-left: 3px solid var(--gold);
  border-radius: var(--radius);
  padding: 12px 14px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.q-card:hover { background: var(--gold-light); transform: translateX(3px); }
.q-card .q-num { font-family: 'IBM Plex Mono', monospace; color: var(--gold); font-size: 11px; flex-shrink: 0; }

/* JP Reference tags */
.jp-refs {
  margin-top: 14px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.jp-tag {
  background: #eef3fb;
  border: 1px solid #c5d3ea;
  color: var(--blue);
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 11px;
  font-family: 'IBM Plex Mono', monospace;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 5px;
}

.jp-tag:hover { background: var(--blue); color: white; }

/* Typing indicator */
.typing {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 10px 0;
}

.typing span {
  width: 7px; height: 7px;
  background: var(--muted2);
  border-radius: 50%;
  animation: bounce 1.2s ease infinite;
}

.typing span:nth-child(2) { animation-delay: 0.15s; }
.typing span:nth-child(3) { animation-delay: 0.3s; }

@keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-6px)} }

/* Input */
.chat-input-zone {
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding: 16px 28px;
  flex-shrink: 0;
}

.input-row {
  display: flex;
  gap: 10px;
  align-items: flex-end;
}

.input-wrap {
  flex: 1;
  background: var(--surface2);
  border: 1.5px solid var(--border2);
  border-radius: 8px;
  overflow: hidden;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.input-wrap:focus-within {
  border-color: var(--navy);
  box-shadow: 0 0 0 3px rgba(26,39,68,0.08);
}

.input-wrap textarea {
  width: 100%;
  padding: 12px 16px;
  font-family: 'IBM Plex Sans', sans-serif;
  font-size: 14px;
  border: none;
  background: transparent;
  resize: none;
  outline: none;
  color: var(--text);
  min-height: 48px;
  max-height: 120px;
}

.input-hint {
  font-size: 11px;
  color: var(--muted2);
  padding: 6px 16px 10px;
}

.btn-send {
  width: 48px;
  height: 48px;
  background: var(--navy);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s, transform 0.1s;
  flex-shrink: 0;
}

.btn-send:hover { background: var(--gold); transform: scale(1.05); }
.btn-send:active { transform: scale(0.97); }

/* Right sidebar â€” context panel */
.context-panel {
  width: 290px;
  flex-shrink: 0;
  border-left: 1px solid var(--border);
  background: var(--surface2);
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.ctx-section-title {
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--muted2);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.ctx-section-title::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

.ctx-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.ctx-item:hover { border-color: var(--gold); box-shadow: var(--shadow); }

.ctx-item-label {
  font-size: 10px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 4px;
}

.ctx-item-value {
  font-size: 12px;
  font-weight: 600;
  color: var(--navy);
}

.ctx-item-sub {
  font-size: 11px;
  color: var(--muted);
  margin-top: 3px;
}

.confidence-bar {
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  margin-top: 8px;
  overflow: hidden;
}

.confidence-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--gold), var(--green));
  border-radius: 2px;
  transition: width 0.8s ease;
}

/* Scenario pills (quick starts) */
.scenario-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
}

.scenario-btn {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
}

.scenario-btn:hover { border-color: var(--navy); background: var(--gold-pale); }

.sc-icon { font-size: 18px; margin-bottom: 4px; }
.sc-text { font-size: 11px; color: var(--navy); font-weight: 500; line-height: 1.3; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PANEL 2 â€” JURISPRUDENCES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.jp-panel-inner {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.jp-list-col {
  width: 360px;
  flex-shrink: 0;
  border-right: 1px solid var(--border);
  overflow-y: auto;
  background: var(--surface2);
}

.jp-search-bar {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
  position: sticky;
  top: 0;
  z-index: 10;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.search-input {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--surface2);
  border: 1.5px solid var(--border2);
  border-radius: var(--radius);
  padding: 8px 12px;
}

.search-input input {
  border: none;
  background: transparent;
  font-family: 'IBM Plex Sans', sans-serif;
  font-size: 13px;
  outline: none;
  flex: 1;
  color: var(--text);
}

.filter-row { display: flex; gap: 6px; flex-wrap: wrap; }

.filter-chip {
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 11px;
  border: 1px solid var(--border2);
  cursor: pointer;
  transition: all 0.2s;
  color: var(--muted);
  background: var(--surface);
}

.filter-chip:hover, .filter-chip.on { background: var(--navy); color: white; border-color: var(--navy); }

.jp-card {
  border-bottom: 1px solid var(--border);
  padding: 16px;
  cursor: pointer;
  transition: background 0.2s;
  position: relative;
}

.jp-card:hover { background: var(--surface); }
.jp-card.selected { background: var(--surface); border-left: 3px solid var(--navy); padding-left: 13px; }

.jp-card-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 6px;
}

.jp-ref {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 11px;
  color: var(--blue);
  font-weight: 500;
}

.jp-domain {
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 500;
}

.dom-urba { background: #e8f0fe; color: #1a4a8a; }
.dom-env { background: #e6f4ea; color: #1a6b3c; }
.dom-const { background: #fff3e0; color: #c8922a; }
.dom-copro { background: #fce4ec; color: #c0392b; }

.jp-card-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--navy);
  line-height: 1.4;
  margin-bottom: 6px;
}

.jp-card-meta {
  font-size: 11px;
  color: var(--muted);
  display: flex;
  gap: 12px;
}

.jp-applicability {
  margin-top: 8px;
  height: 3px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
}

.jp-appli-fill {
  height: 100%;
  border-radius: 2px;
}

/* JP Detail */
.jp-detail-col {
  flex: 1;
  overflow-y: auto;
  padding: 28px;
}

.jp-detail-header {
  border-bottom: 2px solid var(--border);
  padding-bottom: 20px;
  margin-bottom: 24px;
}

.jp-detail-ref {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 13px;
  color: var(--blue);
  margin-bottom: 8px;
}

.jp-detail-title {
  font-family: 'Playfair Display', serif;
  font-size: 22px;
  font-weight: 700;
  color: var(--navy);
  line-height: 1.3;
  margin-bottom: 12px;
}

.jp-meta-row {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}

.jp-meta-item {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.jp-meta-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted2); }
.jp-meta-value { font-size: 13px; font-weight: 600; color: var(--navy); }

.jp-section {
  margin-bottom: 24px;
}

.jp-section-title {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--muted);
  margin-bottom: 12px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border);
}

.jp-section-content {
  font-size: 13px;
  line-height: 1.75;
  color: var(--text);
}

.jp-principe {
  background: var(--gold-pale);
  border-left: 4px solid var(--gold);
  padding: 14px 18px;
  border-radius: 0 var(--radius) var(--radius) 0;
  font-style: italic;
  margin: 12px 0;
  font-size: 13px;
  line-height: 1.7;
}

.jp-applicable-cases {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.jp-case-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  font-size: 13px;
}

.jp-case-icon { color: var(--green); flex-shrink: 0; margin-top: 2px; }

.jp-action-row {
  display: flex;
  gap: 10px;
  margin-top: 24px;
}

.btn { padding: 9px 18px; border-radius: var(--radius); font-size: 13px; font-family: 'IBM Plex Sans', sans-serif; cursor: pointer; border: 1px solid; transition: all 0.2s; font-weight: 500; }
.btn-primary { background: var(--navy); color: white; border-color: var(--navy); }
.btn-primary:hover { background: var(--navy2); }
.btn-outline { background: transparent; color: var(--navy); border-color: var(--border2); }
.btn-outline:hover { border-color: var(--navy); background: var(--gold-pale); }

/* Apprentissage section */
.learn-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #e6f4ea;
  color: var(--green);
  border: 1px solid #a8d5b5;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  margin-top: 8px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PANEL 3 â€” TABLEAU DE BORD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  padding: 28px;
  overflow-y: auto;
  flex: 1;
  align-content: start;
}

.dash-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 20px;
  box-shadow: var(--shadow);
}

.dash-card.wide { grid-column: span 2; }
.dash-card.full { grid-column: span 3; }

.dash-kpi-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--muted);
  margin-bottom: 8px;
}

.dash-kpi-value {
  font-family: 'Playfair Display', serif;
  font-size: 38px;
  font-weight: 700;
  color: var(--navy);
  line-height: 1;
}

.dash-kpi-sub { font-size: 11px; color: var(--muted); margin-top: 6px; }

.dash-card-title {
  font-family: 'Playfair Display', serif;
  font-size: 15px;
  font-weight: 600;
  color: var(--navy);
  margin-bottom: 14px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border);
}

.dash-list { display: flex; flex-direction: column; gap: 10px; }

.dash-row {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
}

.dash-row-label { flex: 1; color: var(--text); }
.dash-row-bar { width: 120px; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
.dash-row-fill { height: 100%; border-radius: 3px; background: var(--navy); }
.dash-row-val { font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: var(--muted); width: 36px; text-align: right; }

.activity-feed { display: flex; flex-direction: column; gap: 12px; }

.activity-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  font-size: 12px;
}

.act-dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 3px; flex-shrink: 0; }
.act-info { flex: 1; line-height: 1.5; }
.act-time { color: var(--muted2); font-size: 11px; white-space: nowrap; }

/* Scrollbars */
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

/* Responsive */
@media (max-width: 900px) {
  .sidebar { width: 220px; }
  .context-panel { width: 220px; }
  .jp-list-col { width: 280px; }
}

/* Animations */
.fade-in { animation: fadeIn 0.4s ease; }
@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

/* Loading dots */
.loading-msg {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 18px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 2px 12px 12px 12px;
  max-width: 120px;
  box-shadow: var(--shadow);
}
</style>
</head>
<body>
<div class="app">

  <!-- â•â• SIDEBAR â•â• -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-mark">
        <div class="logo-icon">âš–ï¸</div>
        <div class="logo-name">UrbaLex</div>
      </div>
      <div class="logo-sub">Droit de l'urbanisme</div>
    </div>

    <div class="sidebar-section">Navigation</div>
    <nav class="sidebar-nav">
      <div class="nav-item active" onclick="showPanel('assistant')">
        <span class="nav-icon">ğŸ’¬</span> Assistant IA
        <span class="nav-badge">actif</span>
      </div>
      <div class="nav-item" onclick="showPanel('jp')">
        <span class="nav-icon">ğŸ“š</span> Jurisprudences
        <span class="nav-badge">42</span>
      </div>
      <div class="nav-item" onclick="showPanel('dashboard')">
        <span class="nav-icon">ğŸ“Š</span> Tableau de bord
      </div>

      <div class="sidebar-section" style="margin-top:8px">Domaines juridiques</div>
      <div class="nav-item" onclick="filterByDomain('urba')">
        <span class="nav-icon">ğŸ›ï¸</span> Code de l'urbanisme
      </div>
      <div class="nav-item" onclick="filterByDomain('const')">
        <span class="nav-icon">ğŸ—ï¸</span> Droit de la construction
      </div>
      <div class="nav-item" onclick="filterByDomain('env')">
        <span class="nav-icon">ğŸŒ¿</span> Environnement & zones
      </div>
      <div class="nav-item" onclick="filterByDomain('copro')">
        <span class="nav-icon">ğŸ </span> CopropriÃ©tÃ© & division
      </div>
    </nav>

    <div class="sidebar-footer">
      <div class="status-dot"></div>
      IA connectÃ©e Â· LÃ©gifrance sync
    </div>
  </aside>

  <!-- â•â• MAIN â•â• -->
  <div class="main">
    <div class="topbar">
      <div class="topbar-title" id="panelTitle">Assistant juridique</div>
      <div class="topbar-pills">
        <span class="pill active" id="pill-fr" onclick="setMode('fr')">ğŸ‡«ğŸ‡· Droit franÃ§ais</span>
        <span class="pill" onclick="alert('Module en dÃ©veloppement')">ğŸ“‹ Nouvelle analyse</span>
        <span class="pill" onclick="alert('Export PDF disponible dans la version complÃ¨te')">â¬‡ Exporter</span>
      </div>
    </div>

    <!-- â•â• PANEL 1 â€” ASSISTANT â•â• -->
    <div class="panel active" id="panel-assistant">
      <div class="chat-wrapper">
        <div class="chat-area">
          <div class="chat-messages" id="chatMessages">

            <!-- Welcome message -->
            <div class="msg assistant fade-in">
              <div class="msg-avatar">âš–ï¸</div>
              <div class="msg-bubble">
                <p>Bonjour, je suis <strong>UrbaLex</strong>, votre assistant spÃ©cialisÃ© en droit de l'urbanisme, de la construction, de l'environnement et de la copropriÃ©tÃ©.</p>
                <p>DÃ©crivez-moi votre situation concrÃ¨te â€” je vais qualifier votre dossier, identifier les textes applicables et rechercher les jurisprudences pertinentes.</p>
                <p style="color:var(--muted); font-size:12px">Exemple : <em>"Je souhaite construire un mur de clÃ´ture de 1,80 m en limite de propriÃ©tÃ© dans une commune couverte par un PLU"</em></p>

                <div style="margin-top:14px">
                  <div style="font-size:11px; color:var(--muted); margin-bottom:8px; text-transform:uppercase; letter-spacing:1px">â€” Ou choisissez un scÃ©nario rapide â€”</div>
                  <div class="scenario-grid">
                    <div class="scenario-btn" onclick="loadScenario('mur')">
                      <div class="sc-icon">ğŸ§±</div>
                      <div class="sc-text">Construire un mur ou clÃ´ture</div>
                    </div>
                    <div class="scenario-btn" onclick="loadScenario('extension')">
                      <div class="sc-icon">ğŸ </div>
                      <div class="sc-text">Extension de maison individuelle</div>
                    </div>
                    <div class="scenario-btn" onclick="loadScenario('division')">
                      <div class="sc-icon">ğŸ“</div>
                      <div class="sc-text">Division parcellaire</div>
                    </div>
                    <div class="scenario-btn" onclick="loadScenario('erp')">
                      <div class="sc-icon">â™¿</div>
                      <div class="sc-text">AccessibilitÃ© ERP</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>

          <div class="chat-input-zone">
            <div class="input-row">
              <div class="input-wrap">
                <textarea id="chatInput" placeholder="DÃ©crivez votre situation urbanistique ou juridiqueâ€¦" rows="2"
                  onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"
                  oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                <div class="input-hint">EntrÃ©e pour envoyer Â· Shift+EntrÃ©e pour nouvelle ligne</div>
              </div>
              <button class="btn-send" onclick="sendMessage()">â¤</button>
            </div>
          </div>
        </div>

        <!-- Context panel -->
        <div class="context-panel">
          <div>
            <div class="ctx-section-title">Dossier en cours</div>
            <div class="ctx-item">
              <div class="ctx-item-label">Situation analysÃ©e</div>
              <div class="ctx-item-value" id="ctx-situation">â€”</div>
            </div>
            <div class="ctx-item">
              <div class="ctx-item-label">Domaine principal</div>
              <div class="ctx-item-value" id="ctx-domain">â€”</div>
              <div class="ctx-item-sub" id="ctx-articles">Articles identifiÃ©s : â€”</div>
            </div>
            <div class="ctx-item">
              <div class="ctx-item-label">Niveau de qualification</div>
              <div class="ctx-item-sub" id="ctx-qual-txt">En attente d'une situation</div>
              <div class="confidence-bar" style="margin-top:8px">
                <div class="confidence-fill" id="ctx-confidence" style="width:0%"></div>
              </div>
            </div>
          </div>

          <div>
            <div class="ctx-section-title">JP applicables</div>
            <div id="ctx-jp-list">
              <div style="font-size:12px; color:var(--muted2); text-align:center; padding:12px">Aucune jurisprudence identifiÃ©e</div>
            </div>
          </div>

          <div>
            <div class="ctx-section-title">Textes de rÃ©fÃ©rence</div>
            <div id="ctx-articles-list">
              <div style="font-size:12px; color:var(--muted2); text-align:center; padding:12px">En attente d'analyse</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â• PANEL 2 â€” JURISPRUDENCES â•â• -->
    <div class="panel" id="panel-jp">
      <div class="jp-panel-inner">
        <div class="jp-list-col">
          <div class="jp-search-bar">
            <div class="search-input">
              <span>ğŸ”</span>
              <input type="text" placeholder="Rechercher une JPâ€¦" id="jpSearch" oninput="filterJP(this.value)">
            </div>
            <div class="filter-row">
              <span class="filter-chip on" onclick="toggleFilter(this,'all')">Tout</span>
              <span class="filter-chip" onclick="toggleFilter(this,'urba')">Urbanisme</span>
              <span class="filter-chip" onclick="toggleFilter(this,'env')">Environnement</span>
              <span class="filter-chip" onclick="toggleFilter(this,'const')">Construction</span>
              <span class="filter-chip" onclick="toggleFilter(this,'copro')">CopropriÃ©tÃ©</span>
            </div>
          </div>
          <div id="jpListContainer"></div>
        </div>

        <div class="jp-detail-col" id="jpDetailCol">
          <div style="display:flex; align-items:center; justify-content:center; height:100%; flex-direction:column; gap:12px; color:var(--muted2)">
            <div style="font-size:40px">ğŸ“‹</div>
            <div style="font-size:14px">SÃ©lectionnez une jurisprudence</div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â• PANEL 3 â€” DASHBOARD â•â• -->
    <div class="panel" id="panel-dashboard">
      <div class="dashboard-grid">
        <div class="dash-card">
          <div class="dash-kpi-label">Analyses rÃ©alisÃ©es</div>
          <div class="dash-kpi-value">127</div>
          <div class="dash-kpi-sub">â†‘ +23 ce mois-ci</div>
        </div>
        <div class="dash-card">
          <div class="dash-kpi-label">JP consultÃ©es</div>
          <div class="dash-kpi-value">42</div>
          <div class="dash-kpi-sub">Base enrichie par IA</div>
        </div>
        <div class="dash-card">
          <div class="dash-kpi-label">Taux de rÃ©solution</div>
          <div class="dash-kpi-value">89%</div>
          <div class="dash-kpi-sub">â†‘ +4 pts vs mois dernier</div>
        </div>

        <div class="dash-card wide">
          <div class="dash-card-title">RÃ©partition des questions par domaine</div>
          <div class="dash-list">
            <div class="dash-row">
              <div class="dash-row-label">Code de l'urbanisme</div>
              <div class="dash-row-bar"><div class="dash-row-fill" style="width:78%; background:#1a2744"></div></div>
              <div class="dash-row-val">78%</div>
            </div>
            <div class="dash-row">
              <div class="dash-row-label">Environnement & zones protÃ©gÃ©es</div>
              <div class="dash-row-bar"><div class="dash-row-fill" style="width:54%; background:#1a6b3c"></div></div>
              <div class="dash-row-val">54%</div>
            </div>
            <div class="dash-row">
              <div class="dash-row-label">Droit de la construction</div>
              <div class="dash-row-bar"><div class="dash-row-fill" style="width:41%; background:#c8922a"></div></div>
              <div class="dash-row-val">41%</div>
            </div>
            <div class="dash-row">
              <div class="dash-row-label">CopropriÃ©tÃ© & division</div>
              <div class="dash-row-bar"><div class="dash-row-fill" style="width:28%; background:#c0392b"></div></div>
              <div class="dash-row-val">28%</div>
            </div>
          </div>
        </div>

        <div class="dash-card">
          <div class="dash-card-title">Apprentissage IA</div>
          <div class="dash-list">
            <div class="dash-row">
              <div class="dash-row-label">JP validÃ©es</div>
              <div class="dash-row-val" style="color:var(--green); font-weight:600">+38</div>
            </div>
            <div class="dash-row">
              <div class="dash-row-label">PrÃ©cision amÃ©liorÃ©e</div>
              <div class="dash-row-val" style="color:var(--green); font-weight:600">+12%</div>
            </div>
            <div class="dash-row">
              <div class="dash-row-label">Nouvelles rÃ¨gles</div>
              <div class="dash-row-val" style="color:var(--navy); font-weight:600">7</div>
            </div>
          </div>
        </div>

        <div class="dash-card full">
          <div class="dash-card-title">ActivitÃ© rÃ©cente</div>
          <div class="activity-feed">
            <div class="activity-item">
              <div class="act-dot" style="background:var(--blue)"></div>
              <div class="act-info"><strong>Analyse : permis de construire</strong> â€” Commune de Saint-Martin Â· Extension de 35mÂ² en zone UB<br><span style="color:var(--muted); font-size:11px">3 jurisprudences identifiÃ©es Â· CE 28 janv. 2020 applicable</span></div>
              <div class="act-time">Il y a 2h</div>
            </div>
            <div class="activity-item">
              <div class="act-dot" style="background:var(--green)"></div>
              <div class="act-info"><strong>JP validÃ©e et ajoutÃ©e</strong> â€” CAA Lyon, 15 mars 2022, nÂ°21LY01234<br><span style="color:var(--muted); font-size:11px">ClÃ´ture en zone agricole Â· AjoutÃ©e Ã  la base d'apprentissage</span></div>
              <div class="act-time">Il y a 5h</div>
            </div>
            <div class="activity-item">
              <div class="act-dot" style="background:var(--gold)"></div>
              <div class="act-info"><strong>Synchronisation LÃ©gifrance</strong> â€” 14 nouvelles dÃ©cisions importÃ©es<br><span style="color:var(--muted); font-size:11px">Domaines : urbanisme (9), environnement (5)</span></div>
              <div class="act-time">Ce matin</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA â€” Jurisprudences
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const JP_DATA = [
  {
    id: "CE-2020-427730",
    ref: "CE, 28 janv. 2020, nÂ°427730",
    title: "Permis de construire â€” ClÃ´ture en limite sÃ©parative",
    domain: "urba",
    juridiction: "Conseil d'Ã‰tat",
    date: "28 janvier 2020",
    rapporteur: "M. Lallet",
    summary: "Le Conseil d'Ã‰tat prÃ©cise que la construction d'une clÃ´ture en limite sÃ©parative est soumise Ã  dÃ©claration prÃ©alable dÃ¨s lors que le PLU communal ne prÃ©voit pas d'exemption, conformÃ©ment Ã  l'article R.421-12 du Code de l'urbanisme.",
    principe: "Une clÃ´ture, mÃªme d'une hauteur infÃ©rieure Ã  2 mÃ¨tres, est soumise Ã  dÃ©claration prÃ©alable en zone urbaine lorsque la commune est couverte par un PLU ou un POS.",
    articles: ["R.421-12 CU", "L.421-4 CU"],
    applicable: ["ClÃ´ture en zone U avec PLU", "Mur de clÃ´ture en limite sÃ©parative", "Haie vÃ©gÃ©tale structurante"],
    score: 94,
    color: "#1a4a8a",
    validated: true
  },
  {
    id: "CAA-LYON-2022-01234",
    ref: "CAA Lyon, 15 mars 2022, nÂ°21LY01234",
    title: "Zone agricole â€” ClÃ´ture de protection de cultures",
    domain: "urba",
    juridiction: "CAA Lyon",
    date: "15 mars 2022",
    rapporteur: "Mme Vinet",
    summary: "La CAA de Lyon confirme qu'en zone agricole (A), une clÃ´ture destinÃ©e Ã  protÃ©ger les cultures d'animaux sauvages peut Ãªtre dispensÃ©e de dÃ©claration prÃ©alable si sa hauteur n'excÃ¨de pas 1,5m et si elle est rÃ©alisÃ©e en matÃ©riaux naturels.",
    principe: "L'objectif agricole d'une clÃ´ture peut la faire bÃ©nÃ©ficier d'une dispense de formalitÃ© en zone A, sous rÃ©serve du respect des matÃ©riaux et dimensions fixÃ©s par le PLU.",
    articles: ["R.421-2 CU", "A-424-16 CU"],
    applicable: ["ClÃ´ture en zone agricole", "Protection de cultures", "MatÃ©riaux naturels â‰¤ 1,5m"],
    score: 81,
    color: "#1a6b3c",
    validated: true
  },
  {
    id: "CE-2019-408356",
    ref: "CE, 12 juin 2019, nÂ°408356",
    title: "ABF â€” Avis conforme en site classÃ©",
    domain: "env",
    juridiction: "Conseil d'Ã‰tat",
    date: "12 juin 2019",
    rapporteur: "M. Daumas",
    summary: "Le Conseil d'Ã‰tat rappelle que dans les pÃ©rimÃ¨tres de protection des monuments historiques, l'avis de l'Architecte des BÃ¢timents de France est conforme et lie l'autoritÃ© compÃ©tente pour dÃ©livrer les autorisations d'urbanisme.",
    principe: "L'avis conforme de l'ABF s'impose Ã  l'autoritÃ© dÃ©livrante. Toute autorisation dÃ©livrÃ©e en contradiction avec un avis dÃ©favorable de l'ABF est entachÃ©e d'illÃ©galitÃ©.",
    articles: ["L.621-32 CH", "R.425-1 CU"],
    applicable: ["Construction en pÃ©rimÃ¨tre ABF", "Modification de faÃ§ade", "ClÃ´ture en site protÃ©gÃ©", "Toute demande dans les 500m d'un MH"],
    score: 88,
    color: "#1a6b3c",
    validated: true
  },
  {
    id: "CAA-BORDEAUX-2021-03567",
    ref: "CAA Bordeaux, 4 nov. 2021, nÂ°20BX03567",
    title: "ERP â€” AccessibilitÃ© et dÃ©rogation recevable",
    domain: "const",
    juridiction: "CAA Bordeaux",
    date: "4 novembre 2021",
    rapporteur: "Mme Cabanne",
    summary: "La CAA de Bordeaux prÃ©cise les conditions dans lesquelles une dÃ©rogation aux rÃ¨gles d'accessibilitÃ© peut Ãªtre accordÃ©e pour un ERP existant. Les difficultÃ©s techniques liÃ©es Ã  la structure du bÃ¢timent constituent un motif valable de dÃ©rogation.",
    principe: "La dÃ©rogation aux normes d'accessibilitÃ© pour ERP existant est recevable lorsque des contraintes structurelles rendent impossible leur application sans dÃ©molition partielle ou modification substantielle du bÃ¢timent.",
    articles: ["L.111-7 CCH", "R.111-19-8 CCH"],
    applicable: ["ERP en bÃ¢timent ancien", "Contraintes techniques structurelles", "DÃ©rogation accessibilitÃ© PMR"],
    score: 76,
    color: "#c8922a",
    validated: false
  },
  {
    id: "CE-2018-399567",
    ref: "CE, 17 oct. 2018, nÂ°399567",
    title: "Division parcellaire â€” Lotissement ou pas ?",
    domain: "copro",
    juridiction: "Conseil d'Ã‰tat",
    date: "17 octobre 2018",
    rapporteur: "M. Lallet",
    summary: "Le Conseil d'Ã‰tat apporte des prÃ©cisions sur la qualification de lotissement lors d'une division fonciÃ¨re. La division d'un terrain en vue de l'implantation de bÃ¢timents sur les parcelles issues de la division constitue un lotissement soumis Ã  autorisation.",
    principe: "Constitue un lotissement toute division d'une propriÃ©tÃ© fonciÃ¨re en vue de l'implantation de bÃ¢timents, que cette division soit opÃ©rÃ©e par vente, location ou tout autre mode de jouissance.",
    articles: ["L.442-1 CU", "R.442-1 CU"],
    applicable: ["Division d'un terrain avec projet de construction", "Vente de parcelle dÃ©tachÃ©e", "CrÃ©ation de lot Ã  bÃ¢tir"],
    score: 83,
    color: "#c0392b",
    validated: true
  },
  {
    id: "CAA-NANTES-2023-00891",
    ref: "CAA Nantes, 3 fÃ©v. 2023, nÂ°22NT00891",
    title: "Natura 2000 â€” Ã‰valuation incidence obligatoire",
    domain: "env",
    juridiction: "CAA Nantes",
    date: "3 fÃ©vrier 2023",
    rapporteur: "M. Degommier",
    summary: "La CAA de Nantes annule un permis de construire faute d'Ã©valuation des incidences Natura 2000. MÃªme pour un projet de faible ampleur, la proximitÃ© d'un site Natura 2000 impose une analyse des incidences potentielles sur les habitats et espÃ¨ces protÃ©gÃ©s.",
    principe: "Tout projet susceptible d'affecter de maniÃ¨re significative un site Natura 2000 doit faire l'objet d'une Ã©valuation des incidences, indÃ©pendamment de la superficie ou de la nature du projet.",
    articles: ["L.414-4 CE", "R.414-19 CE"],
    applicable: ["Projet en zone ou proche d'un site N2000", "Construction en zone humide", "AmÃ©nagement en lisiÃ¨re forestiÃ¨re"],
    score: 90,
    color: "#1a6b3c",
    validated: true
  },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI CONVERSATION LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SCENARIOS = {
  mur: {
    user: "Je souhaite construire un mur de clÃ´ture de 1,80 m en limite de propriÃ©tÃ©. Ma commune a un PLU.",
    response: buildMurResponse
  },
  extension: {
    user: "Je veux agrandir ma maison de 40 mÂ² avec une vÃ©randa cÃ´tÃ© jardin.",
    response: buildExtensionResponse
  },
  division: {
    user: "Je veux diviser mon terrain de 2000 mÂ² pour vendre une parcelle Ã  bÃ¢tir.",
    response: buildDivisionResponse
  },
  erp: {
    user: "Je dois mettre mon commerce en accessibilitÃ© PMR, mais le bÃ¢timent date de 1910.",
    response: buildERPResponse
  }
};

function buildMurResponse() {
  updateContext("ClÃ´ture / mur de 1,80m", "Code de l'urbanisme", "R.421-12, L.421-4", 85,
    ["CE-2020-427730", "CAA-LYON-2022-01234"],
    ["Art. R.421-12 CU â€” DÃ©claration prÃ©alable", "Art. L.421-4 CU â€” Exemptions", "Art. R.424-1 CU â€” DÃ©lais d'instruction"]
  );
  return `<p>J'ai analysÃ© votre situation. Voici ce que j'identifie :</p>
    <p><strong>ğŸ“‹ Qualification juridique</strong><br>
    Une clÃ´ture ou mur en limite sÃ©parative est soumis Ã  <strong>dÃ©claration prÃ©alable de travaux</strong> dÃ¨s lors que votre commune est couverte par un PLU (art. R.421-12 du Code de l'urbanisme).</p>
    <p>Pour affiner mon analyse et vÃ©rifier si des jurisprudences spÃ©cifiques sont applicables Ã  votre cas, j'ai besoin de prÃ©cisions :</p>
    <div class="question-cards">
      <div class="q-card" onclick="answerQ(this, 'Q1')"><span class="q-num">Q1 â€º</span> Votre terrain est-il situÃ© dans une zone ABF (dans les 500m d'un monument historique) ou en site classÃ© ?</div>
      <div class="q-card" onclick="answerQ(this, 'Q2')"><span class="q-num">Q2 â€º</span> Le PLU communal prÃ©cise-t-il des matÃ©riaux ou couleurs obligatoires pour les clÃ´tures ?</div>
      <div class="q-card" onclick="answerQ(this, 'Q3')"><span class="q-num">Q3 â€º</span> S'agit-il d'une zone urbaine (U), Ã  urbaniser (AU), agricole (A) ou naturelle (N) ?</div>
    </div>
    <div class="jp-refs">
      <span class="jp-tag" onclick="openJP('CE-2020-427730')">ğŸ“Œ CE 28 janv. 2020 Â· nÂ°427730</span>
      <span class="jp-tag" onclick="openJP('CAA-LYON-2022-01234')">ğŸ“Œ CAA Lyon 15 mars 2022</span>
    </div>`;
}

function buildExtensionResponse() {
  updateContext("Extension / vÃ©randa 40mÂ²", "Code de l'urbanisme + Construction", "R.421-1, R.421-17, L.111-9", 80,
    ["CE-2019-408356"],
    ["Art. R.421-1 CU â€” Permis de construire", "Art. R.421-17 CU â€” DÃ©claration prÃ©alable", "Art. L.111-9 CU â€” RÃ¨gles de prospect"]
  );
  return `<p>Votre situation implique une <strong>extension de surface de plancher</strong>. Voici la rÃ¨gle gÃ©nÃ©rale :</p>
    <p>â€¢ En zone urbaine couverte par un PLU : <strong>dÃ©claration prÃ©alable</strong> si l'extension est â‰¤ 40 mÂ², <strong>permis de construire</strong> si la surface totale dÃ©passe 150 mÂ² aprÃ¨s travaux.<br>
    â€¢ Hors PLU : dÃ©claration prÃ©alable â‰¤ 20 mÂ², permis au-delÃ .</p>
    <p>Pour confirmer la procÃ©dure exacte applicable, j'ai besoin de :</p>
    <div class="question-cards">
      <div class="q-card" onclick="answerQ(this,'EX1')"><span class="q-num">Q1 â€º</span> Quelle est la surface totale de plancher actuelle de votre habitation ?</div>
      <div class="q-card" onclick="answerQ(this,'EX2')"><span class="q-num">Q2 â€º</span> La vÃ©randa sera-t-elle fermÃ©e et chauffÃ©e (crÃ©ation de surface de plancher) ou ouverte ?</div>
      <div class="q-card" onclick="answerQ(this,'EX3')"><span class="q-num">Q3 â€º</span> ÃŠtes-vous en zone protÃ©gÃ©e (ABF, site Natura 2000, PPRI) ?</div>
    </div>
    <div class="jp-refs">
      <span class="jp-tag" onclick="openJP('CE-2019-408356')">ğŸ“Œ CE 12 juin 2019 Â· ABF</span>
    </div>`;
}

function buildDivisionResponse() {
  updateContext("Division parcellaire", "Droit foncier & urbanisme", "L.442-1, R.442-1", 88,
    ["CE-2018-399567"],
    ["Art. L.442-1 CU â€” DÃ©finition lotissement", "Art. R.442-1 CU â€” Exemptions", "Art. L.442-3 CU â€” Autorisation"]
  );
  return `<p>La division d'un terrain en vue de la construction sur la parcelle dÃ©tachÃ©e constitue en principe un <strong>lotissement</strong> au sens de l'article L.442-1 du Code de l'urbanisme, soumis Ã  <strong>autorisation de lotir</strong>.</p>
    <p>Le Conseil d'Ã‰tat l'a rappelÃ© clairement dans sa dÃ©cision du 17 octobre 2018 : toute division fonciÃ¨re en vue d'implantation de bÃ¢timents est un lotissement.</p>
    <div class="question-cards">
      <div class="q-card" onclick="answerQ(this,'DIV1')"><span class="q-num">Q1 â€º</span> L'acheteur de la parcelle a-t-il un projet de construction prÃ©cis ou la vente est-elle sans destination dÃ©finie ?</div>
      <div class="q-card" onclick="answerQ(this,'DIV2')"><span class="q-num">Q2 â€º</span> La division implique-t-elle la crÃ©ation de voiries ou rÃ©seaux communs ?</div>
    </div>
    <div class="jp-refs">
      <span class="jp-tag" onclick="openJP('CE-2018-399567')">ğŸ“Œ CE 17 oct. 2018 Â· nÂ°399567</span>
    </div>`;
}

function buildERPResponse() {
  updateContext("AccessibilitÃ© ERP bÃ¢timent ancien", "Droit de la construction", "L.111-7, R.111-19-8", 82,
    ["CAA-BORDEAUX-2021-03567"],
    ["Art. L.111-7 CCH â€” AccessibilitÃ©", "Art. R.111-19-8 CCH â€” DÃ©rogations", "Arr. 20 avr. 2017 â€” ERP existants"]
  );
  return `<p>Pour un ERP existant en bÃ¢timent ancien (antÃ©rieur Ã  1948), la mise en accessibilitÃ© est obligatoire mais des <strong>dÃ©rogations motivÃ©es</strong> sont prÃ©vues par l'article R.111-19-8 du CCH.</p>
    <p>La CAA de Bordeaux (nov. 2021) a confirmÃ© que les contraintes structurelles d'un bÃ¢timent ancien constituent un motif valable de dÃ©rogation.</p>
    <div class="question-cards">
      <div class="q-card" onclick="answerQ(this,'ERP1')"><span class="q-num">Q1 â€º</span> Quelle est la catÃ©gorie de votre ERP (1 Ã  5) et son activitÃ© (commerce, accueil, restauration...) ?</div>
      <div class="q-card" onclick="answerQ(this,'ERP2')"><span class="q-num">Q2 â€º</span> Avez-vous dÃ©jÃ  rÃ©alisÃ© un diagnostic accessibilitÃ© par un bureau de contrÃ´le agrÃ©Ã© ?</div>
      <div class="q-card" onclick="answerQ(this,'ERP3')"><span class="q-num">Q3 â€º</span> Quelles sont les contraintes identifiÃ©es (escalier, seuil, largeur de porte...) ?</div>
    </div>
    <div class="jp-refs">
      <span class="jp-tag" onclick="openJP('CAA-BORDEAUX-2021-03567')">ğŸ“Œ CAA Bordeaux 4 nov. 2021</span>
    </div>`;
}

function updateContext(situation, domain, articles, confidence, jpIds, articleList) {
  document.getElementById('ctx-situation').textContent = situation;
  document.getElementById('ctx-domain').textContent = domain;
  document.getElementById('ctx-articles').textContent = "Articles identifiÃ©s : " + articles;
  document.getElementById('ctx-qual-txt').textContent = `Qualification ${confidence}% complÃ¨te`;
  document.getElementById('ctx-confidence').style.width = confidence + '%';

  // JP links
  const jpList = document.getElementById('ctx-jp-list');
  jpList.innerHTML = '';
  jpIds.forEach(id => {
    const jp = JP_DATA.find(j => j.id === id);
    if (!jp) return;
    const div = document.createElement('div');
    div.className = 'ctx-item';
    div.style.cursor = 'pointer';
    div.onclick = () => openJP(id);
    div.innerHTML = `<div class="ctx-item-label">${jp.domain.toUpperCase()}</div>
      <div class="ctx-item-value" style="font-size:11px">${jp.ref}</div>
      <div class="ctx-item-sub">${jp.title}</div>
      <div class="confidence-bar" style="margin-top:8px"><div class="confidence-fill" style="width:${jp.score}%"></div></div>`;
    jpList.appendChild(div);
  });

  // Articles
  const artList = document.getElementById('ctx-articles-list');
  artList.innerHTML = '';
  articleList.forEach(art => {
    const div = document.createElement('div');
    div.className = 'ctx-item';
    div.innerHTML = `<div class="ctx-item-value" style="font-size:12px">ğŸ“œ ${art}</div>`;
    artList.appendChild(div);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const messages = document.getElementById('chatMessages');

function loadScenario(key) {
  const sc = SCENARIOS[key];
  if (!sc) return;
  document.getElementById('chatInput').value = sc.user;
  sendMessage();
}

function answerQ(el, qid) {
  const text = el.querySelector('span:last-child') ? el.textContent.trim() : el.textContent.trim();
  addUserMsg(text.replace(/^Q\d+ â€º /, ''));
  setTimeout(() => {
    addAssistantMsg(buildFollowUp(qid));
  }, 1200);
}

function buildFollowUp(qid) {
  const responses = {
    Q1: `<p>Si votre terrain est dans le pÃ©rimÃ¨tre de protection d'un Monument Historique (500m), l'avis de l'<strong>Architecte des BÃ¢timents de France (ABF)</strong> devient obligatoire et <strong>conforme</strong> (il s'impose Ã  la mairie).</p><p>Dans ce cas, le CE a rappelÃ© en 2019 que tout refus de l'ABF lie l'autoritÃ© compÃ©tente. Je vous recommande de vÃ©rifier votre situation sur le gÃ©oportail de l'urbanisme avant de dÃ©poser votre dÃ©claration.</p>
    <div class="jp-refs"><span class="jp-tag" onclick="openJP('CE-2019-408356')">ğŸ“Œ CE 12 juin 2019 Â· ABF</span></div>`,
    Q2: `<p>Si le PLU prescrit des matÃ©riaux (enduit, pierre, couleur RAL...), ces prescriptions sont opposables et leur non-respect peut entraÃ®ner un <strong>refus ou un retrait</strong> de la dÃ©claration prÃ©alable.</p><p>Consultez le rÃ¨glement de votre zone (annexes graphiques du PLU) pour les articles relatifs aux clÃ´tures, souvent en section sur l'"aspect extÃ©rieur des constructions".</p>`,
    Q3: `<p>En <strong>zone agricole (A)</strong>, les clÃ´tures sont gÃ©nÃ©ralement autorisÃ©es sans formalitÃ© si leur hauteur est infÃ©rieure Ã  1,5m et rÃ©alisÃ©es en matÃ©riaux naturels (haie, grillage). Au-delÃ , une dÃ©claration prÃ©alable est requise.</p>
    <div class="jp-refs"><span class="jp-tag" onclick="openJP('CAA-LYON-2022-01234')">ğŸ“Œ CAA Lyon 2022 Â· Zone A</span></div>`,
    DIV1: `<p>Si la vente est sans destination prÃ©cise de construction, la qualification en lotissement est plus difficile Ã  Ã©tablir. Cependant, si l'acheteur obtient ensuite un permis de construire, la division initiale pourrait a posteriori Ãªtre requalifiÃ©e.</p><p>Il est prudent de soumettre la division Ã  la mairie via un <strong>certificat d'urbanisme opÃ©rationnel (CU-b)</strong> qui sÃ©curise l'opÃ©ration.</p>`,
    DIV2: `<p>La crÃ©ation de voiries ou rÃ©seaux communs confirme sans Ã©quivoque la qualification de <strong>lotissement</strong> et impose une autorisation de lotir avec un dossier complet (rÃ¨glement, cahier des charges).</p>`,
    ERP1: `<p>Pour un ERP de catÃ©gorie 5 (effectif < 200 personnes), les obligations d'accessibilitÃ© sont allÃ©gÃ©es. Un simple <strong>Agenda d'AccessibilitÃ© ProgrammÃ©e (Ad'AP)</strong> peut suffire si les travaux sont trop coÃ»teux.</p><p>Pour les catÃ©gories 1 Ã  4, la mise en conformitÃ© est impÃ©rative sauf dÃ©rogation dÃ»ment motivÃ©e auprÃ¨s de la sous-commission dÃ©partementale d'accessibilitÃ©.</p>`,
    ERP2: `<p>Sans diagnostic, vous risquez de demander une dÃ©rogation sur des bases imprÃ©cises. Un <strong>bureau de contrÃ´le agrÃ©Ã©</strong> peut formaliser les contraintes et constituer le dossier de dÃ©rogation. C'est un investissement qui sÃ©curise considÃ©rablement votre demande.</p>`,
    EX1: `<p>Si la surface de plancher totale aprÃ¨s travaux dÃ©passe <strong>150 mÂ²</strong>, un architecte devient obligatoire et vous devrez dÃ©poser un <strong>permis de construire</strong> (et non une dÃ©claration prÃ©alable).</p>`,
    EX2: `<p>Une vÃ©randa <strong>fermÃ©e et chauffÃ©e</strong> crÃ©e de la surface de plancher, ce qui dÃ©clenche la rÃ¨gle des 40 mÂ² en zone PLU. Une vÃ©randa <strong>ouverte</strong> (sans parois latÃ©rales fixes) peut Ãªtre qualifiÃ©e d'ombriÃ¨re et bÃ©nÃ©ficier du rÃ©gime plus souple des abris de jardin.</p>`,
    EX3: `<p>En zone <strong>Natura 2000</strong>, toute extension peut dÃ©clencher l'obligation d'Ã©valuation des incidences, mÃªme si le projet est modeste. La CAA de Nantes l'a confirmÃ© en 2023 : la proximitÃ© d'un site N2000 impose l'analyse indÃ©pendamment de la superficie.</p>
    <div class="jp-refs"><span class="jp-tag" onclick="openJP('CAA-NANTES-2023-00891')">ğŸ“Œ CAA Nantes 2023 Â· Natura 2000</span></div>`,
    ERP3: `<p>Les contraintes les plus courantes font l'objet de dÃ©rogations acceptÃ©es : <strong>seuil de porte > 2cm</strong> (technique), <strong>rampe impossible</strong> (structure), <strong>largeur insuffisante</strong> (murs porteurs). Documentez chaque contrainte avec photos et plans pour constituer un dossier de dÃ©rogation solide.</p>
    <div class="jp-refs"><span class="jp-tag" onclick="openJP('CAA-BORDEAUX-2021-03567')">ğŸ“Œ CAA Bordeaux 2021 Â· DÃ©rogation</span></div>`
  };
  return responses[qid] || `<p>Merci pour cette prÃ©cision. Je prends en compte cet Ã©lÃ©ment pour affiner l'analyse.</p>`;
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;

  addUserMsg(text);
  input.value = '';
  input.style.height = 'auto';

  // Loading
  const loadId = addLoading();

  // Try to match scenario or call AI
  const matched = Object.values(SCENARIOS).find(s => s.user === text);
  if (matched) {
    setTimeout(() => {
      removeLoading(loadId);
      addAssistantMsg(matched.response());
    }, 1400);
  } else {
    // Call Claude API
    try {
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          system: `Tu es UrbaLex, un assistant juridique expert spÃ©cialisÃ© en droit de l'urbanisme franÃ§ais, droit de la construction, droit de l'environnement et copropriÃ©tÃ©. 
Tu aides des professionnels de l'urbanisme, communes et communautÃ©s de communes.
Tes rÃ©ponses :
- Identifient les textes juridiques applicables (Code de l'urbanisme, CCH, Code de l'environnement)
- Mentionnent les jurisprudences pertinentes (Conseil d'Ã‰tat, Cours administratives d'appel)
- Posent des questions ciblÃ©es pour qualifier la situation
- Sont prÃ©cises, structurÃ©es et professionnelles
- Utilisent des balises HTML simples (p, strong)
- RÃ©fÃ©rences des articles de loi prÃ©cis avec leur code (ex: art. R.421-12 CU)
RÃ©ponds toujours en franÃ§ais.`,
          messages: [{ role: "user", content: text }]
        })
      });
      const data = await response.json();
      removeLoading(loadId);
      const reply = data.content?.[0]?.text || "Je n'ai pas pu analyser votre situation. Veuillez reformuler.";
      addAssistantMsg(`<p>${reply.replace(/\n\n/g, '</p><p>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>`);
    } catch(e) {
      removeLoading(loadId);
      addAssistantMsg(`<p>Je suis connectÃ© en mode local pour cette dÃ©monstration. DÃ©crivez une situation concrÃ¨te d'urbanisme et je vous guiderai sur les textes applicables et jurisprudences pertinentes.</p>
      <div class="question-cards">
        <div class="q-card" onclick="loadScenario('mur')"><span class="q-num">Ex â€º</span> Construire un mur ou une clÃ´ture</div>
        <div class="q-card" onclick="loadScenario('extension')"><span class="q-num">Ex â€º</span> Extension de maison individuelle</div>
      </div>`);
    }
  }
}

function addUserMsg(text) {
  const div = document.createElement('div');
  div.className = 'msg user fade-in';
  div.innerHTML = `<div class="msg-avatar">ğŸ‘¤</div><div class="msg-bubble">${text}</div>`;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function addAssistantMsg(html) {
  const div = document.createElement('div');
  div.className = 'msg assistant fade-in';
  div.innerHTML = `<div class="msg-avatar">âš–ï¸</div><div class="msg-bubble">${html}</div>`;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

let loadingCount = 0;
function addLoading() {
  const id = 'load-' + (++loadingCount);
  const div = document.createElement('div');
  div.className = 'msg assistant fade-in';
  div.id = id;
  div.innerHTML = `<div class="msg-avatar">âš–ï¸</div>
    <div class="loading-msg">
      <div class="typing"><span></span><span></span><span></span></div>
      <span style="font-size:12px; color:var(--muted)">Analyse en coursâ€¦</span>
    </div>`;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
  return id;
}

function removeLoading(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JP PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activeFilter = 'all';
let selectedJP = null;

function renderJPList(data) {
  const container = document.getElementById('jpListContainer');
  container.innerHTML = '';
  data.forEach(jp => {
    const card = document.createElement('div');
    card.className = 'jp-card' + (selectedJP === jp.id ? ' selected' : '');
    card.onclick = () => showJPDetail(jp.id);
    const domClass = { urba:'dom-urba', env:'dom-env', const:'dom-const', copro:'dom-copro' }[jp.domain];
    const domLabel = { urba:'Urbanisme', env:'Environnement', const:'Construction', copro:'CopropriÃ©tÃ©' }[jp.domain];
    card.innerHTML = `
      <div class="jp-card-top">
        <div class="jp-ref">${jp.ref}</div>
        <span class="jp-domain ${domClass}">${domLabel}</span>
      </div>
      <div class="jp-card-title">${jp.title}</div>
      <div class="jp-card-meta">
        <span>ğŸ“… ${jp.date}</span>
        <span>ğŸ›ï¸ ${jp.juridiction}</span>
      </div>
      <div class="jp-applicability">
        <div class="jp-appli-fill" style="width:${jp.score}%; background:${jp.color}"></div>
      </div>`;
    container.appendChild(card);
  });
}

function showJPDetail(id) {
  selectedJP = id;
  const jp = JP_DATA.find(j => j.id === id);
  if (!jp) return;

  // Update list selection
  document.querySelectorAll('.jp-card').forEach(c => c.classList.remove('selected'));
  event && event.currentTarget && event.currentTarget.classList.add('selected');

  const domLabel = { urba:'Code de l\'urbanisme', env:'Environnement & zones protÃ©gÃ©es', const:'Droit de la construction', copro:'CopropriÃ©tÃ© & division' }[jp.domain];

  const detail = document.getElementById('jpDetailCol');
  detail.innerHTML = `
    <div class="jp-detail-header fade-in">
      <div class="jp-detail-ref">${jp.ref}</div>
      <div class="jp-detail-title">${jp.title}</div>
      <div class="jp-meta-row">
        <div class="jp-meta-item"><div class="jp-meta-label">Juridiction</div><div class="jp-meta-value">${jp.juridiction}</div></div>
        <div class="jp-meta-item"><div class="jp-meta-label">Date</div><div class="jp-meta-value">${jp.date}</div></div>
        <div class="jp-meta-item"><div class="jp-meta-label">Domaine</div><div class="jp-meta-value">${domLabel}</div></div>
        <div class="jp-meta-item"><div class="jp-meta-label">ApplicabilitÃ©</div><div class="jp-meta-value" style="color:${jp.color}">${jp.score}/100</div></div>
      </div>
      ${jp.validated ? '<div class="learn-badge">âœ“ ValidÃ©e par l\'IA Â· Enrichit la base d\'apprentissage</div>' : '<div class="learn-badge" style="background:#fff3e0;color:#c8922a;border-color:#f0c060">â³ En attente de validation</div>'}
    </div>

    <div class="jp-section fade-in">
      <div class="jp-section-title">RÃ©sumÃ©</div>
      <div class="jp-section-content">${jp.summary}</div>
    </div>

    <div class="jp-section fade-in">
      <div class="jp-section-title">Principe dÃ©gagÃ©</div>
      <div class="jp-principe">${jp.principe}</div>
    </div>

    <div class="jp-section fade-in">
      <div class="jp-section-title">Articles de rÃ©fÃ©rence</div>
      <div class="jp-section-content">${jp.articles.map(a => `<span class="jp-tag" style="display:inline-flex;margin:3px">ğŸ“œ ${a}</span>`).join('')}</div>
    </div>

    <div class="jp-section fade-in">
      <div class="jp-section-title">Cas d'application</div>
      <div class="jp-applicable-cases">
        ${jp.applicable.map(c => `<div class="jp-case-item"><span class="jp-case-icon">âœ“</span>${c}</div>`).join('')}
      </div>
    </div>

    <div class="jp-action-row fade-in">
      <button class="btn btn-primary" onclick="useInChat('${jp.id}')">ğŸ’¬ Utiliser dans l'assistant</button>
      <button class="btn btn-outline" onclick="alert('Lien LÃ©gifrance : fonctionnalitÃ© disponible avec les credentials API')">ğŸ”— Voir sur LÃ©gifrance</button>
      ${!jp.validated ? `<button class="btn btn-outline" style="color:var(--green);border-color:var(--green)" onclick="validateJP('${jp.id}', this)">âœ“ Valider cette JP</button>` : ''}
    </div>`;
}

function validateJP(id, btn) {
  const jp = JP_DATA.find(j => j.id === id);
  if (jp) { jp.validated = true; showJPDetail(id); }
}

function useInChat(id) {
  const jp = JP_DATA.find(j => j.id === id);
  if (!jp) return;
  showPanel('assistant');
  setTimeout(() => {
    addAssistantMsg(`<p>J'intÃ¨gre la jurisprudence <strong>${jp.ref}</strong> dans notre analyse.</p>
    <p><em>${jp.principe}</em></p>
    <p>Cette dÃ©cision s'applique notamment en cas de : ${jp.applicable.slice(0,2).join(', ')}. Souhaitez-vous que je l'applique Ã  votre situation spÃ©cifique ?</p>`);
  }, 200);
}

function openJP(id) {
  showPanel('jp');
  setTimeout(() => {
    // Re-render list then show detail
    renderJPList(JP_DATA);
    showJPDetail(id);
    // Update visual selection
    document.querySelectorAll('.jp-card').forEach((c, i) => {
      if (JP_DATA[i] && JP_DATA[i].id === id) c.classList.add('selected');
    });
  }, 100);
}

function filterJP(q) {
  const filtered = JP_DATA.filter(jp => {
    const matchQ = !q || jp.title.toLowerCase().includes(q.toLowerCase()) || jp.ref.toLowerCase().includes(q.toLowerCase()) || jp.summary.toLowerCase().includes(q.toLowerCase());
    const matchD = activeFilter === 'all' || jp.domain === activeFilter;
    return matchQ && matchD;
  });
  renderJPList(filtered);
}

function toggleFilter(el, domain) {
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('on'));
  el.classList.add('on');
  activeFilter = domain;
  filterJP(document.getElementById('jpSearch').value);
}

function filterByDomain(domain) {
  showPanel('jp');
  setTimeout(() => { activeFilter = domain; renderJPList(JP_DATA.filter(j => j.domain === domain)); }, 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PANEL NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const panelTitles = {
  assistant: 'Assistant juridique',
  jp: 'Base de jurisprudences',
  dashboard: 'Tableau de bord'
};

function showPanel(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  document.getElementById('panelTitle').textContent = panelTitles[name] || name;
  // Activate matching nav item
  const navItems = document.querySelectorAll('.nav-item');
  const labelMap = { assistant: 'Assistant IA', jp: 'Jurisprudences', dashboard: 'Tableau de bord' };
  navItems.forEach(n => { if (n.textContent.trim().startsWith(labelMap[name] || '___')) n.classList.add('active'); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderJPList(JP_DATA);
</script>
</body>
</html>
